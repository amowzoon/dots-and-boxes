<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dots and Boxes - AI Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 900px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .game-setup {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .setup-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: bold;
            color: #555;
        }

        select, button {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #667eea;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        select {
            background: white;
        }

        button {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .scoreboard {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .score {
            text-align: center;
        }

        .score-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
        }

        .player-a {
            color: #3498db;
        }

        .player-b {
            color: #e74c3c;
        }

        .current-turn {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin: 15px 0;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
        }

        .game-board {
            display: inline-block;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .board-container {
            display: flex;
            justify-content: center;
        }

        .grid {
            display: grid;
            gap: 0;
        }

        .cell {
            position: relative;
            width: 60px;
            height: 60px;
        }

        .dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #333;
            border-radius: 50%;
            top: -6px;
            left: -6px;
            z-index: 10;
        }

        .edge {
            position: absolute;
            background: #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edge:hover:not(.filled) {
            background: #667eea;
            transform: scale(1.05);
        }

        .edge.filled {
            cursor: default;
        }

        .edge.player-a-edge {
            background: #3498db;
        }

        .edge.player-b-edge {
            background: #e74c3c;
        }

        .edge.top, .edge.bottom {
            height: 4px;
            width: 60px;
            left: 0;
        }

        .edge.top {
            top: -2px;
        }

        .edge.bottom {
            bottom: -2px;
        }

        .edge.left, .edge.right {
            width: 4px;
            height: 60px;
            top: 0;
        }

        .edge.left {
            left: -2px;
        }

        .edge.right {
            right: -2px;
        }

        .box-fill {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            border-radius: 5px;
            animation: fillBox 0.3s ease-out;
        }

        @keyframes fillBox {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 0.7;
            }
        }

        .box-fill.player-a {
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }

        .box-fill.player-b {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }

        .game-over-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .modal-content p {
            font-size: 1.3em;
            margin-bottom: 30px;
        }

        .message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Dots and Boxes</h1>
        
        <div class="game-setup">
            <div class="setup-group">
                <label for="gridSize">Grid Size:</label>
                <select id="gridSize">
                    <option value="2">2x2</option>
                    <option value="3" selected>3x3</option>
                    <option value="4">4x4</option>
                    <option value="5">5x5</option>
                    <option value="6">6x6</option>
                </select>
            </div>
            
            <div class="setup-group">
                <label for="difficulty">AI Difficulty:</label>
                <select id="difficulty">
                    <option value="easy">Easy</option>
                    <option value="medium" selected>Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            
            <button id="newGameBtn">New Game</button>
        </div>

        <div class="scoreboard">
            <div class="score">
                <div class="score-label player-a">You (Player A)</div>
                <div class="score-value player-a" id="scoreA">0</div>
            </div>
            <div class="score">
                <div class="score-label player-b">AI (Player B)</div>
                <div class="score-value player-b" id="scoreB">0</div>
            </div>
        </div>

        <div class="current-turn" id="turnIndicator">
            Your Turn!
        </div>

        <div id="messageArea"></div>
        <div class="loading" id="loading">AI is thinking...</div>

        <div class="board-container">
            <div class="game-board">
                <div id="gameBoard" class="grid"></div>
            </div>
        </div>
    </div>

    <div class="game-over-modal" id="gameOverModal">
        <div class="modal-content">
            <h2 id="winnerText">Game Over!</h2>
            <p id="finalScore"></p>
            <button onclick="startNewGame()">Play Again</button>
        </div>
    </div>

    <script>
        // API Key
        const API_KEY = 'Gfpur-UdiWZIdZ7z8zqJYoHFvtko3tg528kihNz00as';  // PASTE YOUR API KEY HERE
        const API_URL = window.location.origin;
        
        // game state
        let gameId = null;
        let currentState = null;
        let gridSize = 3;
        let difficulty = 'medium';
        let waitingForAI = false;

        // API helper functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': API_KEY  // API key authentication
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API request failed');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Initialize game on page load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('newGameBtn').addEventListener('click', startNewGame);
            
            // Check if API key is configured
            if (API_KEY === 'YOUR_API_KEY_HERE') {
                showMessage('‚ö†Ô∏è Please configure your API key in the HTML file!', 'error');
            } else {
                startNewGame();
            }
        });

        async function startNewGame() {
            gridSize = parseInt(document.getElementById('gridSize').value);
            difficulty = document.getElementById('difficulty').value;
            
            try {
                const data = await apiCall('/api/new_game', 'POST', { 
                    grid_size: gridSize 
                });
                
                gameId = data.game_id;
                currentState = data.state;
                
                renderBoard();
                updateUI();
                hideGameOverModal();
                showMessage('New game started! Your turn.', 'success');
            } catch (error) {
                console.error('Error starting new game:', error);
                showMessage('Error starting game: ' + error.message, 'error');
            }
        }

        function renderBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            board.style.gridTemplateColumns = `repeat(${gridSize}, 60px)`;
            board.style.gridTemplateRows = `repeat(${gridSize}, 60px)`;

            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;

                    // Add dot
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    cell.appendChild(dot);

                    // Add edges
                    ['top', 'bottom', 'left', 'right'].forEach(edge => {
                        const edgeDiv = document.createElement('div');
                        edgeDiv.className = `edge ${edge}`;
                        edgeDiv.dataset.row = r;
                        edgeDiv.dataset.col = c;
                        edgeDiv.dataset.edge = edge;
                        edgeDiv.addEventListener('click', () => handleEdgeClick(r, c, edge));
                        cell.appendChild(edgeDiv);
                    });

                    board.appendChild(cell);
                }
            }

            updateBoardState();
        }

        function updateBoardState() {
            if (!currentState) return;

            const board = currentState.board;

            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
                    
                    // Update edges
                    ['top', 'bottom', 'left', 'right'].forEach((edgeName, idx) => {
                        const edge = cell.querySelector(`.edge.${edgeName}`);
                        if (board[r][c][idx] === 1) {
                            edge.classList.add('filled');
                            // Color based on who made the move (simplified - all same for now)
                            edge.classList.add('player-a-edge');
                        }
                    });

                    // Update box ownership
                    const owner = board[r][c][4];
                    if (owner !== 0) {
                        let boxFill = cell.querySelector('.box-fill');
                        if (!boxFill) {
                            boxFill = document.createElement('div');
                            boxFill.className = `box-fill ${owner === 1 ? 'player-a' : 'player-b'}`;
                            boxFill.textContent = owner === 1 ? '‚òÖ' : '‚óè';
                            cell.appendChild(boxFill);
                        }
                    }
                }
            }
        }

        async function handleEdgeClick(row, col, edge) {
            if (waitingForAI || !gameId || currentState.game_over) {
                return;
            }

            if (currentState.current_player !== 1) {
                showMessage('Wait for AI turn!', 'info');
                return;
            }

            try {
                const data = await apiCall('/api/make_move', 'POST', { 
                    game_id: gameId, 
                    row: row, 
                    col: col, 
                    edge: edge 
                });
                
                if (!data.result.valid) {
                    showMessage(data.result.message || 'Invalid move!', 'error');
                    return;
                }

                currentState = data.state;
                updateBoardState();
                updateUI();

                if (data.result.boxes_completed > 0) {
                    showMessage(`You completed ${data.result.boxes_completed} box(es)! Go again!`, 'success');
                }

                if (currentState.game_over) {
                    showGameOver();
                } else if (currentState.current_player === -1) {
                    // AI's turn
                    setTimeout(makeAIMove, 500);
                }
            } catch (error) {
                console.error('Error making move:', error);
                showMessage('Error making move: ' + error.message, 'error');
            }
        }

        async function makeAIMove() {
            if (waitingForAI || currentState.game_over) return;

            waitingForAI = true;
            document.getElementById('loading').style.display = 'block';

            try {
                const data = await apiCall('/api/ai_move', 'POST', { 
                    game_id: gameId, 
                    difficulty: difficulty 
                });
                
                currentState = data.state;
                
                updateBoardState();
                updateUI();

                if (data.result.boxes_completed > 0) {
                    showMessage(`AI completed ${data.result.boxes_completed} box(es)!`, 'info');
                }

                if (currentState.game_over) {
                    showGameOver();
                } else if (currentState.current_player === -1 && currentState.on_offensive) {
                    // AI gets another turn
                    setTimeout(makeAIMove, 500);
                }
            } catch (error) {
                console.error('Error making AI move:', error);
                showMessage('Error with AI move: ' + error.message, 'error');
            } finally {
                waitingForAI = false;
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateUI() {
            if (!currentState) return;

            document.getElementById('scoreA').textContent = currentState.score_A;
            document.getElementById('scoreB').textContent = currentState.score_B;

            const turnIndicator = document.getElementById('turnIndicator');
            if (currentState.game_over) {
                turnIndicator.textContent = 'Game Over!';
            } else if (currentState.current_player === 1) {
                turnIndicator.textContent = 'Your Turn!';
            } else {
                turnIndicator.textContent = 'AI\'s Turn...';
            }
        }

        function showGameOver() {
            const modal = document.getElementById('gameOverModal');
            const winnerText = document.getElementById('winnerText');
            const finalScore = document.getElementById('finalScore');

            const scoreA = currentState.score_A;
            const scoreB = currentState.score_B;

            if (scoreA > scoreB) {
                winnerText.textContent = 'You Win!';
            } else if (scoreB > scoreA) {
                winnerText.textContent = 'AI Wins!';
            } else {
                winnerText.textContent = 'Draw!';
            }

            finalScore.textContent = `Final Score: You ${scoreA} - ${scoreB} AI`;
            modal.style.display = 'flex';
        }

        function hideGameOverModal() {
            document.getElementById('gameOverModal').style.display = 'none';
        }

        function showMessage(text, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }
    </script>
</body>
</html>
